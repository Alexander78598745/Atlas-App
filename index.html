<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas -Nuestros Viajes 仇벒잺</title>
    <link rel="icon" type="image/png" href="atlas-logo.png">
    
    <!-- Configuraci칩n para iOS Home Screen Icon -->
    <link rel="apple-touch-icon" href="atlas-logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="atlas-logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="atlas-logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="atlas-logo.png">
    
    <!-- Apple Splash Screens para diferentes dispositivos iOS -->
    <link rel="apple-touch-startup-image" href="atlas-logo.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="atlas-logo.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="atlas-logo.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="atlas-logo.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Atlas">
    
    <!-- Manifest para PWA -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Gradientes y animaciones para mejor dise침o visual */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.15s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .modal-fade {
            animation: modalFadeIn 0.2s ease-out;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Optimizaciones m칩viles - eliminar transiciones pesadas */
        @media (max-width: 768px) {
            .transition-all, .transition-transform, .transition-colors, .transition {
                transition: none !important;
                animation-duration: 0.01s !important;
            }
            .hover\:scale-110, .hover\:scale-105, .group-hover\:scale-110 {
                transform: none !important;
            }
            .floating-animation { 
                animation-duration: 8s !important; 
            }
            .card-hover {
                transition: none !important;
            }
            .card-hover:hover {
                transform: none !important;
            }
            /* Navegaci칩n suave en m칩vil */
            .nav-link {
                transition: color 0.1s ease;
            }
            /* Scroll horizontal m치s fluido para pesta침as */
            .overflow-x-auto {
                scroll-behavior: smooth;
            }
            /* Ocultar scrollbar pero mantener funcionalidad */
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            
            /* Tama침os responsive adicionales */
            @media (max-width: 475px) {
                .xs\\:hidden { display: none !important; }
            }
            @media (min-width: 476px) {
                .xs\\:hidden { display: block !important; }
            }
            }
            /* Eliminar cualquier animaci칩n pesada */
            * {
                animation-duration: 0.2s !important;
                transition-duration: 0.05s !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header con gradiente -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-32">
                <div class="flex items-center justify-center flex-1">
                    <div class="relative">
                        <img src="ATLAS_transparente_blanco.png" alt="Atlas Logo" class="h-24 w-24 sm:h-32 sm:w-32 lg:h-40 lg:w-40 drop-shadow-2xl mobile-logo object-contain">
                        <div class="absolute inset-0 bg-white/10 rounded-full blur-xl scale-110 opacity-50"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="newTripBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-white/20 hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white backdrop-blur-sm transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i>
                        Nuevo Viaje
                    </button>
                    <div class="relative">
                        <button id="userMenuBtn" class="flex text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white">
                            <img id="userProfileImage" class="h-10 w-10 rounded-full bg-white/20 backdrop-blur-sm border-2 border-white/30" src="https://ui-avatars.com/api/?name=Usuario&background=ffffff&color=667eea" alt="Usuario">
                        </button>
                        <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-48 rounded-xl shadow-lg py-2 bg-white/95 backdrop-blur-md ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <a href="#" onclick="showEditProfile()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                <i class="fas fa-user mr-3 text-blue-600"></i>Editar Perfil
                            </a>
                            <a href="#" onclick="showSettings()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                <i class="fas fa-cog mr-3 text-blue-600"></i>Configuraci칩n
                            </a>
                            <div class="border-t border-gray-100"></div>
                            <a href="#" onclick="logout()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                <i class="fas fa-sign-out-alt mr-3 text-red-600"></i>Cerrar Sesi칩n
                            </a>
                        </div>
                    </div>
                </div>
        </div>
    </header>

    <!-- Navigation con dise침o mejorado -->
    <nav class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-full mx-auto px-2 sm:px-4 lg:px-6">
            <div class="flex space-x-2 sm:space-x-4 lg:space-x-6 overflow-x-auto scrollbar-hide">
                <button data-page="dashboard" class="nav-link group inline-flex items-center px-1 pt-3 pb-3 border-b-2 border-blue-500 text-xs sm:text-sm font-medium text-blue-600 transition-all whitespace-nowrap">
                    <i class="fas fa-tachometer-alt mr-1 sm:mr-2 group-hover:scale-110 transition-transform"></i>Dashboard
                </button>
                <button data-page="routes" class="nav-link group inline-flex items-center px-1 pt-3 pb-3 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-all whitespace-nowrap">
                    <i class="fas fa-route mr-1 sm:mr-2 group-hover:scale-110 transition-transform"></i>Rutas
                </button>
                <button data-page="diary" class="nav-link group inline-flex items-center px-1 pt-3 pb-3 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-all whitespace-nowrap">
                    <i class="fas fa-book mr-1 sm:mr-2 group-hover:scale-110 transition-transform"></i>Diario
                </button>
                <button data-page="planner" class="nav-link group inline-flex items-center px-1 pt-3 pb-3 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-all whitespace-nowrap">
                    <i class="fas fa-calculator mr-1 sm:mr-2 group-hover:scale-110 transition-transform"></i>Planificador
                </button>
            </div>
        </div>
    </nav>

    <!-- Status Banner -->
    <div id="statusBanner" class="hidden bg-gradient-to-r from-green-400 to-green-600 border-l-4 border-green-500 p-4 shadow-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-white"></i>
            </div>
            <div class="ml-3">
                <p id="statusMessage" class="text-sm text-white font-medium"></p>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="hideStatusBanner()" class="inline-flex text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-4xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-compass mr-3 text-blue-600"></i>Dashboard
                        </h2>
                        <p class="mt-2 text-lg text-gray-600">Gestiona tus viajes de forma organizada</p>
                    </div>
                    <div class="hidden sm:block">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full shadow-lg floating-animation">
                            <i class="fas fa-map-marked-alt mr-2"></i>
                            <span class="font-semibold" id="tripCount">0 Viajes</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Estad칤sticas mejoradas -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl shadow-lg card-hover text-white">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-map-marked-alt text-3xl opacity-80"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-blue-100 text-sm font-medium">Viajes Totales</p>
                            <p class="text-3xl font-bold" id="totalTrips">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl shadow-lg card-hover text-white">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-route text-3xl opacity-80"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-green-100 text-sm font-medium">Rutas Disponibles</p>
                            <p class="text-3xl font-bold" id="totalRoutes">3</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl shadow-lg card-hover text-white">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-book text-3xl opacity-80"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-purple-100 text-sm font-medium">Entradas Diario</p>
                            <p class="text-3xl font-bold" id="totalEntries">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-2xl shadow-lg card-hover text-white">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-camera text-3xl opacity-80"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-orange-100 text-sm font-medium">Fotos</p>
                            <p class="text-3xl font-bold" id="totalPhotos">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Viajes Recientes -->
            <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                <div class="px-6 py-5 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-star mr-2 text-yellow-500"></i>Viajes Recientes
                    </h3>
                    <p class="mt-1 text-sm text-gray-600">Tus 칰ltimos viajes planificados</p>
                </div>
                <ul id="recentTripsList" class="divide-y divide-gray-100">
                    <li id="noTripsMessage" class="px-6 py-12">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-map-marked-alt text-4xl text-blue-600"></i>
                            </div>
                            <h3 class="text-xl font-medium text-gray-900 mb-2">No hay viajes a칰n</h3>
                            <p class="text-gray-500 mb-6 max-w-sm mx-auto">Crea tu primer viaje para comenzar a planificar tu aventura</p>
                            <button onclick="createNewTrip()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-lg transition-all duration-200">
                                <i class="fas fa-plus mr-2"></i>Crear Mi Primer Viaje
                            </button>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Routes Page -->
        <div id="routesPage" class="page hidden">
            <div class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-4xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-map mr-3 text-purple-600"></i>Mis Rutas
                        </h2>
                        <p class="mt-2 text-lg text-gray-600">Explora y gestiona tus rutas de viaje</p>
                    </div>
                    <button onclick="createNewRoute()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i>Nueva Ruta
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8 lg:grid-cols-2" id="routesGrid">
                <!-- Rutas din치micas se cargar치n aqu칤 -->
            </div>
        </div>

        <!-- Diary Page con dise침o mejorado -->
        <div id="diaryPage" class="page hidden">
            <div class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-4xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-book-open mr-3 text-indigo-600"></i>Diario de Viajes
                        </h2>
                        <p class="mt-2 text-lg text-gray-600">Documenta tus experiencias y recuerdos</p>
                    </div>
                    <button onclick="openDiaryModal()" class="hidden sm:inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-lg transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i>Nueva Entrada
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Timeline de entradas -->
                <div class="lg:col-span-2">
                    <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                        <ul id="diaryTimeline" class="divide-y divide-gray-100">
                            <li id="noEntriesMessage" class="px-6 py-12">
                                <div class="text-center">
                                    <div class="w-20 h-20 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-book text-4xl text-indigo-600"></i>
                                    </div>
                                    <h3 class="text-xl font-medium text-gray-900 mb-2">No hay entradas a칰n</h3>
                                    <p class="text-gray-500 mb-6">Comienza a documentar tus viajes y momentos especiales</p>
                                    <button onclick="openDiaryModal()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-lg transition-all duration-200">
                                        <i class="fas fa-camera mr-2"></i>Agregar Primera Entrada
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Sidebar mejorado -->
                <div class="space-y-6">
                    <div class="bg-white shadow-xl rounded-2xl p-6 border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-green-600"></i>Estad칤sticas
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-blue-700">Total Entradas</span>
                                    <span class="text-lg font-bold text-blue-900" id="totalEntriesSide">0</span>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-xl">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-green-700">Fotos</span>
                                    <span class="text-lg font-bold text-green-900" id="totalPhotosSide">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot칩n flotante para m칩vil -->
            <button id="floatingDiaryBtn" onclick="openDiaryModal()" class="sm:hidden fixed bottom-6 right-6 h-16 w-16 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full shadow-2xl hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 z-40 flex items-center justify-center floating-animation">
                <i class="fas fa-plus text-xl"></i>
            </button>
            </main>

            <!-- Planner Page -->
            <div id="plannerPage" class="page hidden mx-auto px-4 sm:px-6 lg:px-8 max-w-5xl lg:max-w-6xl" style="margin-left: 1rem; margin-right: 1rem;">
                <div class="mb-8">
                    <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-wallet mr-3 text-green-600"></i>Planificador de Presupuesto
                    </h2>
                    <p class="mt-2 text-base sm:text-lg text-gray-600">Gestiona y planifica el presupuesto de tu viaje</p>
                </div>

                <!-- Selector de Viaje -->
                <div class="bg-white shadow-xl rounded-2xl p-4 sm:p-6 mb-6 border border-gray-100">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 sm:mb-6 flex items-center">
                        <i class="fas fa-map-marked-alt mr-2 text-blue-600"></i>Seleccionar Viaje
                    </h3>
                    <select id="tripSelector" class="w-full p-3 sm:p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 text-sm sm:text-base">
                        <option value="">Selecciona un viaje...</option>
                    </select>
                    <p class="mt-2 text-xs sm:text-sm text-gray-500">Selecciona el viaje al que quieres asignar el presupuesto</p>
                </div>

                <!-- Contenido del planificador -->
                <div id="plannerContent" class="bg-white shadow-xl rounded-2xl p-4 sm:p-6 border border-gray-100">
                    <div class="text-center py-8 sm:py-12">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-green-100 to-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-wallet text-2xl sm:text-4xl text-green-600"></i>
                        </div>
                        <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-2">Selecciona un viaje</h3>
                        <p class="text-sm sm:text-base text-gray-500">Elige un viaje del men칰 superior para comenzar a planificar el presupuesto</p>
                    </div>
                </div>
            </div>
    </main>
    
    <!-- Footer -->
    <footer class="py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm text-blue-600 font-medium">
                <i class="fas fa-heart text-green-400 mr-1"></i>
                creado con Amor 游눜
            </p>
        </div>
    </footer>

    <!-- Modal Nuevo Viaje mejorado -->
    <div id="newTripModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-2xl rounded-2xl bg-white modal-fade">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-plane mr-3 text-blue-600"></i>Crear Nuevo Viaje
                    </h3>
                    <button onclick="closeModal('newTripModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="newTripForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Viaje</label>
                            <input type="text" id="tripName" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Ej: Aventura en Par칤s">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Destino Principal</label>
                            <input type="text" id="tripDestination" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Ej: Par칤s, Francia">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Inicio</label>
                            <input type="date" id="tripStartDate" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Fin</label>
                            <input type="date" id="tripEndDate" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ubicaciones Adicionales (opcional)</label>
                        <div id="additionalLocationsContainer" class="space-y-2">
                            <div class="flex space-x-2">
                                <input type="text" name="additionalLocations" class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Ej: Versalles">
                                <button type="button" onclick="removeLocationField(this)" class="px-3 py-3 text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 rounded-xl transition-colors hidden">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" onclick="addLocationField()" class="mt-2 inline-flex items-center px-3 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-1"></i>A침adir otro destino
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci칩n</label>
                        <textarea id="tripDescription" rows="3" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Describe tu viaje so침ado..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-6">
                        <button type="button" onclick="closeModal('newTripModal')" class="px-6 py-3 text-base font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-8 py-3 text-base font-medium text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-xl shadow-lg transition-all duration-200">
                            <i class="fas fa-plus mr-2"></i>Crear Viaje
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Entrada Diario -->
    <div id="diaryModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-2xl rounded-2xl bg-white modal-fade">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-camera mr-3 text-indigo-600"></i>Nueva Entrada de Diario
                    </h3>
                    <button onclick="closeModal('diaryModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="diaryForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T칤tulo</label>
                        <input type="text" id="entryTitle" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Ej: Primer d칤a en Par칤s">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                        <input type="date" id="entryDate" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ubicaci칩n</label>
                        <input type="text" id="entryLocation" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Ej: Torre Eiffel, Par칤s">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contenido</label>
                        <textarea id="entryContent" rows="4" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Describe tu experiencia..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fotos (opcional)</label>
                        <input type="file" id="entryPhotos" multiple accept="image/*" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div class="flex justify-end space-x-4 pt-6">
                        <button type="button" onclick="closeModal('diaryModal')" class="px-6 py-3 text-base font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-8 py-3 text-base font-medium text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-xl shadow-lg transition-all duration-200">
                            <i class="fas fa-save mr-2"></i>Guardar Entrada
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Perfil -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-2xl rounded-2xl bg-white modal-fade">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-user-edit mr-3 text-green-600"></i>Editar Perfil
                    </h3>
                    <button onclick="closeModal('editProfileModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editProfileForm" class="space-y-6">
                    <div class="text-center">
                        <div class="mb-4">
                            <img id="profilePhotoPreview" class="h-24 w-24 rounded-full mx-auto border-4 border-green-200" src="https://ui-avatars.com/api/?name=Usuario&background=22c55e&color=fff" alt="Foto de perfil">
                        </div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto de Perfil</label>
                        <input type="file" id="userProfilePhoto" accept="image/*" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" onchange="previewProfilePhoto(event)">
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                            <input type="text" id="userName" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Tu nombre completo">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="userEmail" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="tu@email.com">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 pt-6">
                        <button type="button" onclick="closeModal('editProfileModal')" class="px-6 py-3 text-base font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-8 py-3 text-base font-medium text-white bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 rounded-xl shadow-lg transition-all duration-200">
                            <i class="fas fa-save mr-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Ruta -->
    <div id="newRouteModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-2xl rounded-2xl bg-white modal-fade">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-route mr-3 text-purple-600"></i>Crear Nueva Ruta
                    </h3>
                    <button onclick="closeModal('newRouteModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="newRouteForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Ruta</label>
                            <input type="text" id="routeName" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" placeholder="Ej: Tour por Par칤s">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dificultad</label>
                            <select id="routeDifficulty" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                <option value="">Selecciona dificultad</option>
                                <option value="F치cil">F치cil</option>
                                <option value="Moderada">Moderada</option>
                                <option value="Dif칤cil">Dif칤cil</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Duraci칩n</label>
                            <input type="text" id="routeDuration" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" placeholder="Ej: 3 d칤as">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lugares Destacados</label>
                            <input type="text" id="routeHighlights" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" placeholder="Ej: Torre Eiffel, Louvre...">
                            <p class="text-xs text-gray-500 mt-1">Separa los lugares con comas</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci칩n</label>
                        <textarea id="routeDescription" rows="3" required class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" placeholder="Describe tu ruta..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Actividades por D칤a (opcional)</label>
                        <div id="routeDaysContainer" class="space-y-3">
                            <div class="border border-gray-200 rounded-xl p-4 bg-gray-50">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-medium text-gray-900">D칤a 1</h4>
                                </div>
                                <textarea name="routeDay1" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" placeholder="Ej: Ma침ana: Torre Eiffel, Tarde: Barrio Latin"></textarea>
                            </div>
                        </div>
                        <button type="button" onclick="addRouteDay()" class="mt-3 inline-flex items-center px-3 py-2 text-sm font-medium text-purple-600 hover:text-purple-800 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-1"></i>A침adir d칤a
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Si dejas esto vac칤o, se crear치 un d칤a general con actividades b치sicas</p>
                    </div>
                    <div class="flex justify-end space-x-4 pt-6">
                        <button type="button" onclick="closeModal('newRouteModal')" class="px-6 py-3 text-base font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-8 py-3 text-base font-medium text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-xl shadow-lg transition-all duration-200">
                            <i class="fas fa-plus mr-2"></i>Crear Ruta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalles de Ruta -->
    <div id="routeDetailsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-2xl rounded-2xl bg-white modal-fade">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-route mr-3 text-purple-600"></i>Detalles de la Ruta
                    </h3>
                    <button onclick="closeModal('routeDetailsModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="routeDetailsContent" class="space-y-6">
                    <!-- Contenido din치mico -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let atlasApp = {
            currentPage: 'dashboard',
            trips: JSON.parse(localStorage.getItem('atlasTrips') || '[]'),
            routes: [
                {
                    id: 1,
                    name: "Ruta de Par칤s",
                    description: "Visita los lugares m치s emblem치ticos de Par칤s en 3 d칤as",
                    duration: "3 d칤as",
                    difficulty: "F치cil",
                    highlights: ["Torre Eiffel", "Louvre", "Notre-Dame", "Campos El칤seos"],
                    itinerary: [
                        { day: 1, activities: ["Ma침ana: Torre Eiffel", "Tarde: Barrio Latin", "Noche: Crucero por el Sena"] },
                        { day: 2, activities: ["Ma침ana: Louvre", "Tarde: Notre-Dame", "Noche: Montmartre"] },
                        { day: 3, activities: ["Ma침ana: Campos El칤seos", "Tarde: Versalles", "Noche: Cena en Le Marais"] }
                    ]
                },
                {
                    id: 2,
                    name: "Camino de Santiago",
                    description: "Ruta hist칩rica y espiritual a trav칠s de Espa침a",
                    duration: "7 d칤as",
                    difficulty: "Moderada",
                    highlights: ["Catedral de Santiago", "Ponte de Lei", "Praza do Obradoiro", "Casa do Concello"],
                    itinerary: [
                        { day: 1, activities: ["Llegada a Santiago", "Visita a la Catedral", "Cena en el casco hist칩rico"] },
                        { day: 2, activities: ["Camino hacia Ponte de Lei", "Visita al monasterio", "Pernocte en ponte"] },
                        { day: 3, activities: ["Retorno a Santiago", "Praza do Obradoiro", "Visita a la Universidad"] }
                    ]
                },
                {
                    id: 3,
                    name: "Ruta de Barcelona",
                    description: "Explora la ciudad condal y sus maravillas arquitect칩nicas",
                    duration: "4 d칤as",
                    difficulty: "F치cil",
                    highlights: ["Sagrada Familia", "Park G칲ell", "Las Ramblas", "Barrio G칩tico"],
                    itinerary: [
                        { day: 1, activities: ["Ma침ana: Sagrada Familia", "Tarde: Eixample", "Noche: Las Ramblas"] },
                        { day: 2, activities: ["Ma침ana: Park G칲ell", "Tarde: Gr맊ia", "Noche: Tapas en El Born"] },
                        { day: 3, activities: ["Ma침ana: Barrio G칩tico", "Tarde: La Boquer칤a", "Noche: Montju칦c"] }
                    ]
                }
            ],
            diaryEntries: JSON.parse(localStorage.getItem('atlasDiaryEntries') || '[]'),
            user: {
                name: "Usuario Atlas",
                email: "usuario@atlas.com",
                profilePhoto: null
            }
        };

        // Inicializaci칩n
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos del usuario desde localStorage
            const savedUser = localStorage.getItem('atlasUser');
            if (savedUser) {
                atlasApp.user = { ...atlasApp.user, ...JSON.parse(savedUser) };
            }
            
            // Actualizar fecha por defecto en formulario de diario
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            
            // Cargar imagen de perfil
            updateUserProfileImage();
            
            // Cargar contenido inicial
            loadDashboardContent();
            loadRoutesContent();
            loadDiaryContent();
            loadPlannerContent();
            
            // Event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });

            // User menu
            document.getElementById('userMenuBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleUserMenu();
            });

            // New trip button
            document.getElementById('newTripBtn').addEventListener('click', createNewTrip);

            // Forms
            document.getElementById('newTripForm').addEventListener('submit', handleNewTripSubmit);
            document.getElementById('diaryForm').addEventListener('submit', handleDiarySubmit);
            document.getElementById('editProfileForm').addEventListener('submit', handleProfileSubmit);
            document.getElementById('newRouteForm').addEventListener('submit', handleNewRouteSubmit);

            // Trip selector in planner
            document.getElementById('tripSelector').addEventListener('change', handleTripSelection);

            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                document.getElementById('userMenuDropdown').classList.add('hidden');
            });
        }

        // Funci칩n para cambiar de p치gina
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            document.getElementById(pageName + 'Page').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('border-blue-500', 'text-blue-600');
                link.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-page="${pageName}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`[data-page="${pageName}"]`).classList.add('border-blue-500', 'text-blue-600');
            
            atlasApp.currentPage = pageName;
            
            // Load content for page
            if (pageName === 'dashboard') {
                loadDashboardContent();
            } else if (pageName === 'routes') {
                loadRoutesContent();
            } else if (pageName === 'diary') {
                loadDiaryContent();
            } else if (pageName === 'planner') {
                loadPlannerContent();
            }
        }

        // Funciones de contenido
        function loadDashboardContent() {
            updateStatistics();
            loadRecentTrips();
        }

        function loadRoutesContent() {
            const routesGrid = document.getElementById('routesGrid');
            routesGrid.innerHTML = '';
            
            atlasApp.routes.forEach(route => {
                const routeCard = document.createElement('div');
                routeCard.className = 'bg-white overflow-hidden shadow-xl rounded-2xl border border-gray-100 card-hover';
                routeCard.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-900">${route.name}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-blue-100 to-purple-100 text-blue-800">
                                    ${route.difficulty}
                                </span>
                                <button onclick="window.deleteRoute(${route.id})" class="text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors" title="Eliminar ruta">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-4">${route.description}</p>
                        <div class="flex items-center text-sm text-gray-500 mb-6">
                            <i class="fas fa-clock mr-2"></i>
                            <span class="mr-6">${route.duration}</span>
                            <i class="fas fa-star mr-2"></i>
                            <span>${route.highlights.length} lugares</span>
                        </div>
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl mb-6">
                            <div class="text-xs text-gray-500 mb-2">Highlights:</div>
                            <div class="flex flex-wrap gap-2">
                                ${route.highlights.slice(0, 3).map(h => `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">#${h}</span>`).join('')}
                                ${route.highlights.length > 3 ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">+${route.highlights.length - 3} m치s</span>` : ''}
                            </div>
                        </div>
                        <button onclick="showRouteDetails(${route.id})" class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium rounded-xl transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-info-circle mr-2"></i>Ver detalles 
                        </button>
                    </div>
                `;
                routesGrid.appendChild(routeCard);
            });
        }

        function loadDiaryContent() {
            const timeline = document.getElementById('diaryTimeline');
            const noEntriesMsg = document.getElementById('noEntriesMessage');
            
            if (atlasApp.diaryEntries.length === 0) {
                if (noEntriesMsg) noEntriesMsg.classList.remove('hidden');
            } else {
                if (noEntriesMsg) noEntriesMsg.classList.add('hidden');
                timeline.innerHTML = atlasApp.diaryEntries.map(entry => `
                    <li class="px-6 py-4">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-book text-white"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-lg font-semibold text-gray-900">${entry.title}</h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm text-gray-500">${formatDate(entry.date)}</span>
                                        <button onclick="window.deleteDiaryEntry(${entry.id})" class="text-red-500 hover:text-red-700 p-1 hover:bg-red-50 rounded transition-colors" title="Eliminar entrada">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                ${entry.location ? `<p class="text-sm text-blue-600 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${entry.location}</p>` : ''}
                                <p class="text-gray-600 mt-2">${entry.content}</p>
                                ${entry.photos && entry.photos.length > 0 ? `
                                    <div class="mt-4">
                                        <div class="flex flex-wrap gap-3">
                                            ${entry.photos.slice(0, 3).map(photo => `
                                                <div class="relative group cursor-pointer" onclick="showFullPhoto('${photo}')">
                                                    <img src="${photo}" alt="Foto" class="w-24 h-24 object-cover rounded-xl hover:scale-105 transition-transform shadow-lg">
                                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-xl transition-all flex items-center justify-center">
                                                        <i class="fas fa-search-plus text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${entry.photos.length > 3 ? `<div class="flex items-center justify-center w-24 h-24 bg-gray-100 rounded-xl text-sm text-gray-500 font-medium">+${entry.photos.length - 3} m치s</div>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </li>
                `).join('');
            }
            
            updateStatistics();
        }

        function loadPlannerContent() {
            const tripSelector = document.getElementById('tripSelector');
            const plannerContent = document.getElementById('plannerContent');
            
            // Actualizar selector de viajes
            tripSelector.innerHTML = '<option value="">Selecciona un viaje...</option>';
            atlasApp.trips.forEach(trip => {
                const option = document.createElement('option');
                option.value = trip.id;
                option.textContent = `${trip.name} - ${trip.destination}`;
                tripSelector.appendChild(option);
            });
            
            // Contenido por defecto
            if (!tripSelector.value) {
                plannerContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gradient-to-br from-green-100 to-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-wallet text-4xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-2">Selecciona un viaje</h3>
                        <p class="text-gray-500">Elige un viaje del men칰 superior para comenzar a planificar el presupuesto</p>
                    </div>
                `;
            }
        }

        function loadRecentTrips() {
            const tripsList = document.getElementById('recentTripsList');
            
            if (!tripsList) {
                console.log('Elemento recentTripsList no encontrado');
                return;
            }
            
            const noTripsMsg = document.getElementById('noTripsMessage');
            
            if (atlasApp.trips.length === 0) {
                tripsList.innerHTML = '';
                if (noTripsMsg) {
                    noTripsMsg.classList.remove('hidden');
                }
            } else {
                if (noTripsMsg) {
                    noTripsMsg.classList.add('hidden');
                }
                tripsList.innerHTML = atlasApp.trips.slice(0, 5).map(trip => {
                    const today = new Date();
                    const startDate = new Date(trip.startDate);
                    const endDate = new Date(trip.endDate);
                    let status = 'planificado';
                    let statusIcon = 'fas fa-calendar-plus';
                    let statusColor = 'bg-blue-100 text-blue-800';
                    
                    if (today > endDate) {
                        status = 'finalizado';
                        statusIcon = 'fas fa-check-circle';
                        statusColor = 'bg-green-100 text-green-800';
                    } else if (today >= startDate && today <= endDate) {
                        status = 'en progreso';
                        statusIcon = 'fas fa-plane';
                        statusColor = 'bg-orange-100 text-orange-800';
                    }
                    
                    return `
                        <li class="px-6 py-6 hover:bg-gray-50 transition-colors border-l-4 border-blue-500">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center cursor-pointer" onclick="showTripDetails(${trip.id})">
                                            <i class="fas fa-map-marked-alt text-white"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-lg font-semibold text-gray-900 cursor-pointer hover:text-blue-600" onclick="showTripDetails(${trip.id})">${trip.name}</div>
                                        <div class="text-sm text-gray-500">
                                            ${trip.destination}${trip.locationsArray ? `  ${trip.locationsArray.join(', ')}` : (trip.locations ? `  ${trip.locations}` : '')}
                                        </div>
                                        <div class="mt-1">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                                <i class="${statusIcon} mr-1"></i>${status.charAt(0).toUpperCase() + status.slice(1)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <div class="text-right">
                                        <div class="font-medium">${formatDate(trip.startDate)}</div>
                                        <div>hasta ${formatDate(trip.endDate)}</div>
                                    </div>
                                </div>
                            </div>
                            ${trip.description ? `<p class="mt-3 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">${trip.description}</p>` : ''}
                            <div class="mt-4 flex items-center justify-between">
                                <div class="flex items-center text-sm text-gray-500">
                                    <i class="fas fa-calendar mr-2"></i>
                                    <span>${calculateDuration(trip.startDate, trip.endDate)}</span>
                                    ${trip.routes && trip.routes.length > 0 ? `
                                        <span class="mx-3"></span>
                                        <i class="fas fa-route mr-2"></i>
                                        <span>${trip.routes.length} ruta(s)</span>
                                    ` : ''}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="showTripDetails(${trip.id})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-purple-600 hover:text-purple-800 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                                        <i class="fas fa-eye mr-1"></i>Ver detalles
                                    </button>
                                    <button onclick="editTrip(${trip.id})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                                        <i class="fas fa-edit mr-1"></i>Editar
                                    </button>
                                    <button onclick="confirmDeleteTrip(${trip.id})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                                        <i class="fas fa-trash mr-1"></i>Eliminar
                                    </button>
                                </div>
                            </div>
                        </li>
                    `;
                }).join('');
            }
        }

        // Funciones principales
        function createNewTrip() {
            document.getElementById('newTripModal').classList.remove('hidden');
        }

        function createNewRoute() {
            document.getElementById('newRouteModal').classList.remove('hidden');
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown.classList.toggle('hidden');
        }

        function openDiaryModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            document.getElementById('diaryModal').classList.remove('hidden');
        }

        function showEditProfile() {
            closeModal('userMenuDropdown');
            document.getElementById('editProfileModal').classList.remove('hidden');
            // Cargar datos actuales
            document.getElementById('userName').value = atlasApp.user.name;
            document.getElementById('userEmail').value = atlasApp.user.email;
            
            // Cargar foto de perfil
            const previewImg = document.getElementById('profilePhotoPreview');
            if (atlasApp.user.profilePhoto) {
                previewImg.src = atlasApp.user.profilePhoto;
            } else {
                previewImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(atlasApp.user.name || 'Usuario')}&background=22c55e&color=fff`;
            }
        }

        function showSettings() {
            closeModal('userMenuDropdown');
            showNotification('Configuraci칩n (funci칩n en desarrollo)', 'info');
        }

        function logout() {
            closeModal('userMenuDropdown');
            showNotification('Cerrando sesi칩n...', 'info');
        }

        function editTrip(tripId) {
            const trip = atlasApp.trips.find(t => t.id === tripId);
            if (trip) {
                // Reset locations container
                const container = document.getElementById('additionalLocationsContainer');
                container.innerHTML = '';
                
                // A침adir campos para ubicaciones existentes
                const locationsArray = trip.locationsArray || (trip.locations ? trip.locations.split(', ') : []);
                if (locationsArray.length > 0) {
                    locationsArray.forEach((location, index) => {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'flex space-x-2';
                        fieldDiv.innerHTML = `
                            <input type="text" name="additionalLocations" class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" value="${location}">
                            <button type="button" onclick="removeLocationField(this)" class="px-3 py-3 text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 rounded-xl transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        container.appendChild(fieldDiv);
                    });
                } else {
                    // A침adir un campo vac칤o
                    addLocationField();
                }
                updateLocationRemoveButtons();
                
                // Llenar otros campos
                document.getElementById('tripName').value = trip.name;
                document.getElementById('tripDestination').value = trip.destination;
                document.getElementById('tripStartDate').value = trip.startDate;
                document.getElementById('tripEndDate').value = trip.endDate;
                document.getElementById('tripDescription').value = trip.description;
                
                // Marcar como edici칩n
                document.getElementById('newTripModal').dataset.editId = tripId;
                document.querySelector('#newTripModal h3').innerHTML = '<i class="fas fa-edit mr-3 text-blue-600"></i>Editar Viaje';
                
                document.getElementById('newTripModal').classList.remove('hidden');
            }
        }

        function confirmDeleteTrip(tripId) {
            const trip = atlasApp.trips.find(t => t.id === tripId);
            if (!trip) return;

            const confirmed = confirm(`쮼st치s seguro de que deseas eliminar el viaje "${trip.name}"?\n\nEsta acci칩n no se puede deshacer.`);
            if (confirmed) {
                deleteTrip(tripId);
            }
        }

        async function deleteTrip(tripId) {
            const tripIndex = atlasApp.trips.findIndex(t => t.id === tripId);
            if (tripIndex === -1) {
                console.error('仇 Viaje no encontrado para eliminar:', tripId);
                showNotification('Error: Viaje no encontrado', 'error');
                return;
            }
            
            const tripName = atlasApp.trips[tripIndex].name;
            console.log('游딈勇 ELIMINACI칍N CR칈TICA:', tripName, 'ID:', tripId);
            
            // BLOQUEO TEMPORAL DEL REAL-TIME SYNC PARA EVITAR INTERFERENCIAS
            atlasApp.tripsyncDisabled = true;
            console.log('游 REAL-TIME SYNC DESHABILITADO TEMPORALMENTE PARA ELIMINACI칍N');
            
            try {
                // PASO 1: Eliminar del array local INMEDIATAMENTE
                atlasApp.trips.splice(tripIndex, 1);
                console.log('九 PASO 1: Viaje eliminado del array local');
                
                // PASO 2: Guardar en localStorage INMEDIATAMENTE
                const savedTrips = JSON.stringify(atlasApp.trips);
                localStorage.setItem('atlasTrips', savedTrips);
                console.log('游 PASO 2: localStorage actualizado con', atlasApp.trips.length, 'viajes');
                
                // PASO 3: Forzar actualizaci칩n UI inmediata
                loadRecentTrips();
                updateStatistics();
                
                // PASO 4: SINCRONIZACI칍N CR칈TICA CON FIREBASE
                if (typeof atlasApp !== 'undefined' && atlasApp.firestore && typeof auth !== 'undefined') {
                    const userId = auth.currentUser ? auth.currentUser.uid : 'anonymous';
                    console.log('游댠 PASO 4: SINCRONIZACI칍N CR칈TICA Firebase - Usuario:', userId);
                    
                    // Funci칩n para sincronizar con Firebase con reintentos
                    const syncToFirebase = async (attempt = 1) => {
                        try {
                            const timestamp = new Date().toISOString();
                            await atlasApp.firestore.collection('users').doc(userId).collection('trips').doc('data').set({
                                trips: atlasApp.trips,
                                lastUpdated: timestamp,
                                deletionSync: true,
                                deletionId: tripId, // Marcar espec칤ficamente qu칠 viaje se elimin칩
                                deletionTime: timestamp,
                                syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Actualizar timestamp local para tracking
                            localStorage.setItem('atlasTripsTimestamp', timestamp);
                            
                            console.log('九 SINCRONIZACI칍N FIREBASE EXITOSA - Viaje eliminado definitivamente');
                            return true;
                            
                        } catch (error) {
                            console.error(`仇 Error Firebase (intento ${attempt}):`, error);
                            
                            if (attempt < 3) {
                                // Reintentar con backoff exponencial
                                const delay = Math.pow(2, attempt) * 500;
                                console.log(`游댃 Reintentando en ${delay}ms...`);
                                setTimeout(() => syncToFirebase(attempt + 1), delay);
                            } else {
                                console.error('仇 M츼XIMOS REINTENTOS ALCANZADOS - Eliminaci칩n local preservada');
                            }
                            return false;
                        }
                    };
                    
                    // Ejecutar sincronizaci칩n inmediata
                    await syncToFirebase();
                    
                } else {
                    console.log('丘멆잺 PASO 4: Firebase no disponible - Solo guardado localmente');
                }
                
                // PASO 5: Verificaci칩n POST-eliminaci칩n
                setTimeout(() => {
                    const checkTrips = JSON.parse(localStorage.getItem('atlasTrips') || '[]');
                    console.log('游댌 VERIFICACI칍N FINAL:', {
                        localStorage: checkTrips.length,
                        arrayLocal: atlasApp.trips.length,
                        consistencia: checkTrips.length === atlasApp.trips.length
                    });
                    
                    if (checkTrips.length !== atlasApp.trips.length) {
                        console.error('仇 INCONSISTENCIA DETECTADA - Forzando correcci칩n');
                        localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
                        atlasApp.trips = checkTrips;
                    } else {
                        console.log('九 ELIMINACI칍N DEFINITIVA COMPLETADA');
                    }
                    
                    // REACTIVAR REAL-TIME SYNC DESPU칄S DE LA ELIMINACI칍N
                    setTimeout(() => {
                        atlasApp.tripsyncDisabled = false;
                        console.log('游댑 REAL-TIME SYNC REACTIVADO - Eliminaci칩n completa');
                    }, 1000);
                    
                }, 200);
                
                // Mostrar notificaci칩n
                showNotification(`Viaje "${tripName}" eliminado definitivamente`, 'success');
                
            } catch (error) {
                console.error('仇 ERROR CR칈TICO en eliminaci칩n:', error);
                showNotification('Error cr칤tico al eliminar viaje. Recarga la p치gina.', 'error');
                
                // REACTIVAR REAL-TIME SYNC EN CASO DE ERROR
                atlasApp.tripsyncDisabled = false;
                console.log('游댑 REAL-TIME SYNC REACTIVADO (por error en eliminaci칩n)');
            }
        }

        function showRouteDetails(routeId) {
            const route = atlasApp.routes.find(r => r.id === routeId);
            if (!route) return;

            const content = document.getElementById('routeDetailsContent');
            content.innerHTML = `
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-2xl border border-purple-100">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-2xl font-bold text-gray-900">${route.name}</h4>
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gradient-to-r from-purple-100 to-blue-100 text-purple-800">
                            ${route.difficulty}
                        </span>
                    </div>
                    <p class="text-gray-600 mb-6">${route.description}</p>
                    <div class="flex items-center space-x-6 text-sm text-gray-500 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-clock mr-2"></i>
                            <span>${route.duration}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-star mr-2"></i>
                            <span>${route.highlights.length} lugares destacados</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl border border-gray-100">
                    <h5 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>Itinerario Detallado
                    </h5>
                    <div class="space-y-4">
                        ${route.itinerary.map(day => `
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl border-l-4 border-blue-500">
                                <h6 class="font-semibold text-gray-900 mb-2">D칤a ${day.day}</h6>
                                <ul class="space-y-1">
                                    ${day.activities.map(activity => `
                                        <li class="text-sm text-gray-700 flex items-center">
                                            <i class="fas fa-circle text-blue-400 mr-2 text-xs"></i>
                                            ${activity}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl border border-gray-100">
                    <h5 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>Lugares Destacados
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${route.highlights.map(place => `
                            <div class="flex items-center p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-100">
                                <i class="fas fa-map-pin text-green-600 mr-3"></i>
                                <span class="text-gray-700 font-medium">${place}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('routeDetailsModal').classList.remove('hidden');
        }

        // Handlers de formularios
        function handleNewTripSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('tripName').value;
            const destination = document.getElementById('tripDestination').value;
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;
            const description = document.getElementById('tripDescription').value;
            
            // Obtener ubicaciones adicionales din치micas
            const locationInputs = document.querySelectorAll('#additionalLocationsContainer input[name="additionalLocations"]');
            const locations = Array.from(locationInputs)
                .map(input => input.value.trim())
                .filter(location => location.length > 0);
            const locationsText = locations.join(', ');
            
            const editId = e.target.closest('#newTripModal').dataset.editId;
            
            if (editId) {
                // Editar viaje existente
                const trip = atlasApp.trips.find(t => t.id == editId);
                if (trip) {
                    trip.name = name;
                    trip.destination = destination;
                    trip.locations = locationsText;
                    trip.locationsArray = locations;
                    trip.startDate = startDate;
                    trip.endDate = endDate;
                    trip.description = description;
                    
                    // Save updated trips to localStorage and Firebase
                    localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
                    
                    // Sync with Firebase
                    if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                        atlasApp.firebaseSync.saveTrips();
                    }
                    
                    // Actualizar inmediatamente la lista de viajes recientes
                    loadRecentTrips();
                    
                    // Actualizar estad칤sticas
                    updateStatistics();
                    
                    // Cerrar modal inmediatamente
                    closeModal('newTripModal');
                    
                    showNotification('Viaje actualizado correctamente', 'success');
                }
                delete e.target.closest('#newTripModal').dataset.editId;
                e.target.querySelector('#newTripModal h3').innerHTML = '<i class="fas fa-plane mr-3 text-blue-600"></i>Crear Nuevo Viaje';
            } else {
                // Crear nuevo viaje
                const newTrip = {
                    id: Date.now(),
                    name,
                    destination,
                    locations: locationsText,
                    locationsArray: locations,
                    startDate,
                    endDate,
                    description,
                    routes: [],
                    budget: {}
                };
                atlasApp.trips.unshift(newTrip);
                localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
                
                // Sync with Firebase
                if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                    atlasApp.firebaseSync.saveTrips();
                }
                
                showNotification(`Viaje "${name}" creado correctamente`, 'success');
                
                // Actualizar inmediatamente la lista de viajes recientes
                loadRecentTrips();
                
                // Actualizar estad칤sticas
                updateStatistics();
            }
            
            // Limpiar y cerrar formulario
            e.target.reset();
            
            // Reset locations container
            const container = document.getElementById('additionalLocationsContainer');
            container.innerHTML = `
                <div class="flex space-x-2">
                    <input type="text" name="additionalLocations" class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Ej: Versalles">
                    <button type="button" onclick="removeLocationField(this)" class="px-3 py-3 text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 rounded-xl transition-colors hidden">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            closeModal('newTripModal');
            loadDashboardContent();
            loadPlannerContent();
        }

        function handleDiarySubmit(e) {
            e.preventDefault();
            
            const title = document.getElementById('entryTitle').value;
            const date = document.getElementById('entryDate').value;
            const location = document.getElementById('entryLocation').value;
            const content = document.getElementById('entryContent').value;
            const photosInput = document.getElementById('entryPhotos');
            
            // Crear entrada sin fotos primero
            const entry = {
                id: Date.now(),
                title,
                date,
                location,
                content,
                photos: []
            };
            
            // Procesar fotos de forma s칤ncrona
            if (photosInput.files.length > 0) {
                const photosPromises = Array.from(photosInput.files).map(file => {
                    if (file.type.startsWith('image/')) {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                resolve(e.target.result);
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                    return Promise.resolve(null);
                });
                
                Promise.all(photosPromises).then(photos => {
                    entry.photos = photos.filter(photo => photo !== null);
                    
                    // A침adir al diario y guardar
                    atlasApp.diaryEntries.unshift(entry);
                    localStorage.setItem('atlasDiaryEntries', JSON.stringify(atlasApp.diaryEntries));
                    
                    // Sync with Firebase
                    if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                        atlasApp.firebaseSync.saveDiaryEntries();
                    }
                    
                    showNotification('Entrada agregada al diario', 'success');
                    
                    // Limpiar y cerrar formulario
                    e.target.reset();
                    closeModal('diaryModal');
                    loadDiaryContent();
                });
            } else {
                // No hay fotos, a침adir directamente
                atlasApp.diaryEntries.unshift(entry);
                localStorage.setItem('atlasDiaryEntries', JSON.stringify(atlasApp.diaryEntries));
                
                // Sync with Firebase
                if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                    atlasApp.firebaseSync.saveDiaryEntries();
                }
                
                showNotification('Entrada agregada al diario', 'success');
                
                // Limpiar y cerrar formulario
                e.target.reset();
                closeModal('diaryModal');
                loadDiaryContent();
            }
        }

        function previewProfilePhoto(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('profilePhotoPreview');
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function updateUserProfileImage() {
            const profileImg = document.getElementById('userProfileImage');
            const previewImg = document.getElementById('profilePhotoPreview');
            
            if (atlasApp.user.profilePhoto) {
                const imgSrc = atlasApp.user.profilePhoto;
                profileImg.src = imgSrc;
                if (previewImg) previewImg.src = imgSrc;
            } else {
                const defaultSrc = `https://ui-avatars.com/api/?name=${encodeURIComponent(atlasApp.user.name || 'Usuario')}&background=ffffff&color=667eea`;
                profileImg.src = defaultSrc;
                if (previewImg) previewImg.src = defaultSrc;
            }
        }

        function handleProfileSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const profilePhotoInput = document.getElementById('userProfilePhoto');
            
            atlasApp.user.name = name;
            atlasApp.user.email = email;
            
            // Manejar foto de perfil
            if (profilePhotoInput.files.length > 0) {
                const file = profilePhotoInput.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        atlasApp.user.profilePhoto = event.target.result;
                        updateUserProfileImage();
                        localStorage.setItem('atlasUser', JSON.stringify(atlasApp.user));
                        
                        // Sync with Firebase
                        if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                            atlasApp.firebaseSync.saveUser();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                updateUserProfileImage();
                localStorage.setItem('atlasUser', JSON.stringify(atlasApp.user));
                
                // Sync with Firebase
                if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                    atlasApp.firebaseSync.saveUser();
                }
            }
            
            showNotification('Perfil actualizado correctamente', 'success');
            
            // Sync with Firebase
            if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                atlasApp.firebaseSync.saveUser();
            }
            
            // Limpiar input de archivo pero mantener la imagen de preview
            profilePhotoInput.value = '';
            closeModal('editProfileModal');
        }

        function handleNewRouteSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('routeName').value;
            const description = document.getElementById('routeDescription').value;
            const duration = document.getElementById('routeDuration').value;
            const difficulty = document.getElementById('routeDifficulty').value;
            const highlights = document.getElementById('routeHighlights').value.split(',').map(h => h.trim()).filter(h => h);
            
            // Parsear itinerario de los d칤as din치micos
            const itinerary = [];
            const dayContainers = document.querySelectorAll('#routeDaysContainer > div');
            
            if (dayContainers.length > 0) {
                dayContainers.forEach((container, index) => {
                    const dayNumber = index + 1;
                    const textarea = container.querySelector('textarea');
                    const dayText = textarea ? textarea.value.trim() : '';
                    
                    if (dayText) {
                        // Dividir las actividades por comas o saltos de l칤nea
                        const activities = dayText.split(/[,\n]/).map(a => a.trim()).filter(a => a);
                        if (activities.length > 0) {
                            itinerary.push({ day: dayNumber, activities });
                        }
                    }
                });
            }
            
            // Si no hay d칤as espec칤ficos, crear uno general
            if (itinerary.length === 0) {
                itinerary.push({ day: 1, activities: ['Actividades generales'] });
            }
            
            const newRoute = {
                id: Date.now(),
                name,
                description,
                duration,
                difficulty,
                highlights,
                itinerary: itinerary.length > 0 ? itinerary : [{ day: 1, activities: ['Actividades generales'] }]
            };
            
            atlasApp.routes.push(newRoute);
            localStorage.setItem('atlasRoutes', JSON.stringify(atlasApp.routes));
            
            // Sync with Firebase
            if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                atlasApp.firebaseSync.saveRoutes();
            }
            
            showNotification(`Ruta "${name}" creada correctamente`, 'success');
            
            e.target.reset();
            // Reset days container to just day 1
            document.getElementById('routeDaysContainer').innerHTML = `
                <div class="border border-gray-200 rounded-xl p-4 bg-gray-50">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-900">D칤a 1</h4>
                    </div>
                    <textarea name="routeDay1" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" placeholder="Ej: Ma침ana: Torre Eiffel, Tarde: Barrio Latin"></textarea>
                </div>
            `;
            closeModal('newRouteModal');
            loadRoutesContent();
        }

        function handleTripSelection(e) {
            const tripId = parseInt(e.target.value);
            const plannerContent = document.getElementById('plannerContent');
            
            if (!tripId) {
                plannerContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gradient-to-br from-green-100 to-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-wallet text-4xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-2">Selecciona un viaje</h3>
                        <p class="text-gray-500">Elige un viaje del men칰 superior para comenzar a planificar el presupuesto</p>
                    </div>
                `;
                return;
            }
            
            const trip = atlasApp.trips.find(t => t.id === tripId);
            if (!trip) return;
            
            // Mostrar planificador de presupuesto
            plannerContent.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-2xl border border-blue-100">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">${trip.name}</h3>
                        <p class="text-gray-600">${trip.destination}  ${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}</p>
                        <p class="text-sm text-gray-500 mt-2">${trip.description || 'Sin descripci칩n'}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${['Alojamiento', 'Comida', 'Transporte', 'Actividades', 'Compras', 'Otros'].map(category => {
                            const value = (trip.budget && trip.budget[category]) || '';
                            return `
                                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                    <h4 class="font-medium text-gray-900 mb-3">${category}</h4>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" value="${value}" placeholder="0" class="w-20 p-2 border border-gray-300 rounded-lg text-sm" onchange="updateBudget(${tripId}, '${category}', this.value)">
                                        <span class="text-sm text-gray-500"></span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-2xl border border-green-100">
                        <h4 class="text-lg font-bold text-gray-900 mb-4">Resumen del Presupuesto</h4>
                        <div class="text-2xl font-bold text-green-600" id="totalBudget">
                            ${Object.values(trip.budget || {}).reduce((sum, val) => sum + (val || 0), 0)}
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Total calculado para ${calculateDuration(trip.startDate, trip.endDate)}</p>
                        <div class="mt-4 flex justify-between items-center">
                            <button onclick="clearBudget(${tripId})" class="px-4 py-2 text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200 rounded-lg transition-colors">
                                <i class="fas fa-trash mr-1"></i>Limpiar Presupuesto
                            </button>
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-save mr-1"></i>Se guarda autom치ticamente
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateBudget(tripId, category, amount) {
            const trip = atlasApp.trips.find(t => t.id === tripId);
            if (!trip) return;
            
            if (!trip.budget) trip.budget = {};
            trip.budget[category] = parseFloat(amount) || 0;
            
            localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
            
            // Sync with Firebase
            if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                atlasApp.firebaseSync.saveTrips();
            }
            
            // Recalcular total
            const total = Object.values(trip.budget).reduce((sum, val) => sum + (val || 0), 0);
            const totalBudgetEl = document.getElementById('totalBudget');
            if (totalBudgetEl) {
                totalBudgetEl.textContent = `${total}`;
            }
        }

        function clearBudget(tripId) {
            const trip = atlasApp.trips.find(t => t.id === tripId);
            if (!trip) return;
            
            if (confirm('쮼st치s seguro de que quieres limpiar todo el presupuesto?')) {
                trip.budget = {};
                localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
                
                // Sync with Firebase
                if (atlasApp.firebaseSyncEnabled && atlasApp.firebaseSync) {
                    atlasApp.firebaseSync.saveTrips();
                }
                
                showNotification('Presupuesto limpiado', 'success');
                
                // Actualizar vista del planificador
                handleTripSelection({ target: { value: tripId } });
            }
        }

        // Funciones auxiliares
        function updateStatistics() {
            document.getElementById('totalTrips').textContent = atlasApp.trips.length;
            document.getElementById('tripCount').textContent = `${atlasApp.trips.length} Viajes`;
            document.getElementById('totalRoutes').textContent = atlasApp.routes.length;
            document.getElementById('totalEntries').textContent = atlasApp.diaryEntries.length;
            document.getElementById('totalEntriesSide').textContent = atlasApp.diaryEntries.length;
            
            const totalPhotos = atlasApp.diaryEntries.reduce((sum, entry) => sum + (entry.photos ? entry.photos.length : 0), 0);
            document.getElementById('totalPhotos').textContent = totalPhotos;
            document.getElementById('totalPhotosSide').textContent = totalPhotos;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays === 1 ? '1 d칤a' : `${diffDays} d칤as`;
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showNotification(message, type) {
            const banner = document.getElementById('statusBanner');
            const messageEl = document.getElementById('statusMessage');
            
            messageEl.textContent = message;
            banner.classList.remove('hidden');
            
            setTimeout(() => {
                hideStatusBanner();
            }, 3000);
        }

        function hideStatusBanner() {
            document.getElementById('statusBanner').classList.add('hidden');
        }

        // Funciones adicionales para las nuevas caracter칤sticas
        function showTripDetails(tripId) {
            const trip = atlasApp.trips.find(t => t.id === tripId);
            if (!trip) return;

            // Determinar estado del viaje
            const today = new Date();
            const startDate = new Date(trip.startDate);
            const endDate = new Date(trip.endDate);
            let status = 'Planificado';
            let statusIcon = 'fas fa-calendar-plus';
            let statusColor = 'text-blue-600';
            
            if (today > endDate) {
                status = 'Finalizado';
                statusIcon = 'fas fa-check-circle';
                statusColor = 'text-green-600';
            } else if (today >= startDate && today <= endDate) {
                status = 'En Progreso';
                statusIcon = 'fas fa-plane';
                statusColor = 'text-orange-600';
            }

            // Obtener entradas del diario relacionadas
            const relatedEntries = atlasApp.diaryEntries.filter(entry => 
                entry.content.toLowerCase().includes(trip.destination.toLowerCase()) ||
                (trip.locations && entry.content.toLowerCase().includes(trip.locations.toLowerCase()))
            );

            // Obtener fotos del viaje
            const tripPhotos = relatedEntries.flatMap(entry => entry.photos || []);

            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-2xl rounded-2xl bg-white modal-fade">
                    <div class="mt-3">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-3xl font-bold text-gray-900 flex items-center">
                                <i class="fas fa-map-marked-alt mr-3 text-blue-600"></i>${trip.name}
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Informaci칩n Principal -->
                            <div class="lg:col-span-2 space-y-6">
                                <!-- Estado y Fechas -->
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-2xl border border-blue-100">
                                    <div class="flex items-center justify-between mb-4">
                                        <div>
                                            <h4 class="text-xl font-bold text-gray-900">Estado del Viaje</h4>
                                            <div class="flex items-center mt-2">
                                                <i class="${statusIcon} ${statusColor} mr-2 text-lg"></i>
                                                <span class="text-lg font-semibold ${statusColor}">${status}</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm text-gray-500">Duraci칩n</div>
                                            <div class="font-semibold">${calculateDuration(trip.startDate, trip.endDate)}</div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-white p-4 rounded-xl">
                                            <div class="text-sm text-gray-500">Fecha de Inicio</div>
                                            <div class="font-semibold text-gray-900">${formatDate(trip.startDate)}</div>
                                        </div>
                                        <div class="bg-white p-4 rounded-xl">
                                            <div class="text-sm text-gray-500">Fecha de Fin</div>
                                            <div class="font-semibold text-gray-900">${formatDate(trip.endDate)}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Destinos -->
                                <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <h4 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>Destinos
                                    </h4>
                                    <div class="space-y-3">
                                        <div class="flex items-center p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg">
                                            <i class="fas fa-star text-red-500 mr-3"></i>
                                            <div>
                                                <div class="font-semibold text-gray-900">Destino Principal</div>
                                                <div class="text-sm text-gray-600">${trip.destination}</div>
                                            </div>
                                        </div>
                                        ${trip.locationsArray ? trip.locationsArray.map(location => `
                                            <div class="flex items-center p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                                                <i class="fas fa-map-pin text-blue-500 mr-3"></i>
                                                <div class="font-semibold text-gray-900">${location}</div>
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                </div>

                                <!-- Descripci칩n -->
                                ${trip.description ? `
                                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                        <h4 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>Descripci칩n
                                        </h4>
                                        <p class="text-gray-700 leading-relaxed">${trip.description}</p>
                                    </div>
                                ` : ''}

                                <!-- Presupuesto -->
                                ${trip.budget && Object.keys(trip.budget).length > 0 ? `
                                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                        <h4 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                            <i class="fas fa-wallet mr-2 text-green-500"></i>Presupuesto Planificado
                                        </h4>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            ${Object.entries(trip.budget).map(([category, amount]) => `
                                                <div class="bg-gradient-to-r from-green-50 to-blue-50 p-3 rounded-lg">
                                                    <div class="text-sm text-gray-600">${category}</div>
                                                    <div class="font-bold text-gray-900">${amount || 0}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="mt-4 pt-4 border-t border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <span class="text-lg font-semibold text-gray-900">Total:</span>
                                                <span class="text-2xl font-bold text-green-600">
                                                    ${Object.values(trip.budget).reduce((sum, val) => sum + (val || 0), 0)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Sidebar -->
                            <div class="space-y-6">
                                <!-- Fotos del Viaje -->
                                ${tripPhotos.length > 0 ? `
                                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                        <h4 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                            <i class="fas fa-camera mr-2 text-purple-500"></i>Fotos (${tripPhotos.length})
                                        </h4>
                                        <div class="grid grid-cols-2 gap-2">
                                            ${tripPhotos.slice(0, 6).map(photo => `
                                                <img src="${photo}" alt="Foto del viaje" class="w-full h-20 object-cover rounded-lg cursor-pointer hover:scale-105 transition-transform" onclick="showFullPhoto('${photo}')">
                                            `).join('')}
                                        </div>
                                        ${tripPhotos.length > 6 ? `<div class="mt-2 text-center text-sm text-gray-500">+${tripPhotos.length - 6} fotos m치s</div>` : ''}
                                    </div>
                                ` : ''}

                                <!-- Entradas de Diario -->
                                ${relatedEntries.length > 0 ? `
                                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                        <h4 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                            <i class="fas fa-book mr-2 text-indigo-500"></i>Diario (${relatedEntries.length})
                                        </h4>
                                        <div class="space-y-3">
                                            ${relatedEntries.slice(0, 3).map(entry => `
                                                <div class="p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                                                    <div class="font-semibold text-gray-900 text-sm">${entry.title}</div>
                                                    <div class="text-xs text-gray-600">${formatDate(entry.date)}</div>
                                                    ${entry.location ? `<div class="text-xs text-blue-600 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${entry.location}</div>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Acciones -->
                                <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <h4 class="text-xl font-bold text-gray-900 mb-4">Acciones</h4>
                                    <div class="space-y-3">
                                        <button onclick="editTrip(${trip.id}); this.closest('.fixed').remove();" class="w-full inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-edit mr-2"></i>Editar Viaje
                                        </button>
                                        <button onclick="showPage('planner'); document.getElementById('tripSelector').value = ${trip.id}; handleTripSelection({target: {value: ${trip.id}}}); this.closest('.fixed').remove();" class="w-full inline-flex items-center justify-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                            <i class="fas fa-calculator mr-2"></i>Ver Presupuesto
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showFullPhoto(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <img src="${photoUrl}" alt="Foto completa" class="max-w-full max-h-full object-contain rounded-lg">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        function addLocationField() {
            const container = document.getElementById('additionalLocationsContainer');
            const newField = document.createElement('div');
            newField.className = 'flex space-x-2';
            newField.innerHTML = `
                <input type="text" name="additionalLocations" class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Ej: Disneyland Par칤s">
                <button type="button" onclick="removeLocationField(this)" class="px-3 py-3 text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 rounded-xl transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(newField);
            
            // Mostrar bot칩n de eliminar en el primer campo si hay m치s de uno
            updateLocationRemoveButtons();
        }

        function removeLocationField(button) {
            const container = document.getElementById('additionalLocationsContainer');
            const fields = container.querySelectorAll('.flex.space-x-2');
            
            if (fields.length > 1) {
                button.closest('.flex.space-x-2').remove();
                updateLocationRemoveButtons();
            }
        }

        function updateLocationRemoveButtons() {
            const container = document.getElementById('additionalLocationsContainer');
            const fields = container.querySelectorAll('.flex.space-x-2');
            const removeButtons = container.querySelectorAll('button[onclick*="removeLocationField"]');
            
            removeButtons.forEach(button => {
                button.classList.toggle('hidden', fields.length === 1);
            });
        }

        function addRouteDay() {
            const container = document.getElementById('routeDaysContainer');
            const dayCount = container.children.length + 1;
            
            const newDay = document.createElement('div');
            newDay.className = 'border border-gray-200 rounded-xl p-4 bg-gray-50';
            newDay.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-900">D칤a ${dayCount}</h4>
                    <button type="button" onclick="removeRouteDay(this)" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <textarea name="routeDay${dayCount}" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" placeholder="Ej: Ma침ana: Museo del Louvre, Tarde: Notre-Dame"></textarea>
            `;
            
            container.appendChild(newDay);
        }

        function removeRouteDay(button) {
            const container = document.getElementById('routeDaysContainer');
            const days = container.children.length;
            
            if (days > 1) {
                button.closest('.border.border-gray-200').remove();
                
                // Renumerar d칤as
                Array.from(container.children).forEach((dayEl, index) => {
                    const dayNumber = index + 1;
                    dayEl.querySelector('h4').textContent = `D칤a ${dayNumber}`;
                    dayEl.querySelector('textarea').name = `routeDay${dayNumber}`;
                    dayEl.querySelector('textarea').placeholder = `Ej: Ma침ana: Actividad d칤a ${dayNumber}, Tarde: Otra actividad`;
                });
            }
        }

        function deleteRoute(routeId) {
            console.log('游딈勇 ELIMINANDO RUTA - ID:', routeId);
            
            const route = atlasApp.routes.find(r => String(r.id) === String(routeId));
            if (!route) {
                console.error('仇 Ruta no encontrada:', routeId);
                return;
            }
            
            if (!confirm(`쮼liminar ruta "${route.name}"?`)) return;
            
            // 游 BLOQUEO TOTAL
            atlasApp.tripsyncDisabled = true;
            
            // ELIMINACI칍N LOCAL COMPLETA
            const originalLength = atlasApp.routes.length;
            atlasApp.routes = atlasApp.routes.filter(r => String(r.id) !== String(routeId));
            
            // LIMPIAR TODOS LOS ALMACENES LOCALES
            localStorage.setItem('atlasRoutes', JSON.stringify(atlasApp.routes));
            localStorage.removeItem('atlasRoutesTimestamp');
            localStorage.removeItem('routesData');
            localStorage.setItem('deletedRoutes', JSON.stringify([...new Set([...JSON.parse(localStorage.getItem('deletedRoutes') || '[]'), String(routeId)])]));
            
            console.log(`九 Rutas: ${originalLength}  ${atlasApp.routes.length}`);
            
            // ACTUALIZAR INTERFAZ INMEDIATAMENTE
            loadRoutesContent();
            
            // 游댠 FIREBASE - ELIMINACI칍N TOTAL Y PERMANENTE
            const forceFirebaseSync = async () => {
                try {
                    const userId = auth.currentUser ? auth.currentUser.uid : 'anonymous';
                    
                    // ELIMINAR COMPLETAMENTE el documento y recrearlo
                    await atlasApp.firestore.collection('users').doc(userId).collection('routes').doc('data').delete();
                    
                    // Esperar un momento y recrear con datos nuevos
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // NUEVO documento completamente limpio
                    await atlasApp.firestore.collection('users').doc(userId).collection('routes').doc('data').set({
                        routes: atlasApp.routes,
                        lastUpdated: new Date().toISOString(),
                        version: Date.now(),
                        deletedRouteIds: [...new Set([...JSON.parse(localStorage.getItem('deletedRoutes') || '[]'), String(routeId)])]
                    });
                    
                    console.log('九 FIREBASE ELIMINACI칍N PERMANENTE COMPLETADA');
                    
                } catch (error) {
                    console.error('仇 FIREBASE ERROR:', error);
                    setTimeout(forceFirebaseSync, 1500);
                }
            };
            
            forceFirebaseSync();
            
            // 游댑 REACTIVAR DESPU칄S DE 8 SEGUNDOS
            setTimeout(() => {
                atlasApp.tripsyncDisabled = false;
                console.log('游댑 SYNC REACTIVADA');
            }, 8000);
            
            showNotification(`Ruta eliminada permanentemente`, 'success');
        }

        function deleteDiaryEntry(entryId) {
            console.log('游딈勇 ELIMINANDO DIARY - ID:', entryId);
            
            const entry = atlasApp.diaryEntries.find(e => String(e.id) === String(entryId));
            if (!entry) {
                console.error('仇 Entrada no encontrada:', entryId);
                return;
            }
            
            if (!confirm(`쮼liminar entrada "${entry.title}"?`)) return;
            
            // 游 BLOQUEO TOTAL
            atlasApp.tripsyncDisabled = true;
            
            // ELIMINACI칍N LOCAL COMPLETA
            const originalLength = atlasApp.diaryEntries.length;
            atlasApp.diaryEntries = atlasApp.diaryEntries.filter(e => String(e.id) !== String(entryId));
            
            // LIMPIAR TODOS LOS ALMACENES LOCALES
            localStorage.setItem('atlasDiaryEntries', JSON.stringify(atlasApp.diaryEntries));
            localStorage.removeItem('atlasDiaryEntriesTimestamp');
            localStorage.setItem('deletedDiaryEntries', JSON.stringify([...new Set([...JSON.parse(localStorage.getItem('deletedDiaryEntries') || '[]'), String(entryId)])]));
            
            console.log(`九 Diary: ${originalLength}  ${atlasApp.diaryEntries.length}`);
            
            // ACTUALIZAR INTERFAZ INMEDIATAMENTE
            loadDiaryContent();
            
            // 游댠 FIREBASE - ELIMINACI칍N TOTAL Y PERMANENTE
            const forceFirebaseSync = async () => {
                try {
                    const userId = auth.currentUser ? auth.currentUser.uid : 'anonymous';
                    
                    // ELIMINAR COMPLETAMENTE el documento y recrearlo
                    await atlasApp.firestore.collection('users').doc(userId).collection('diary').doc('data').delete();
                    
                    // Esperar un momento y recrear con datos nuevos
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // NUEVO documento completamente limpio
                    await atlasApp.firestore.collection('users').doc(userId).collection('diary').doc('data').set({
                        entries: atlasApp.diaryEntries,
                        lastUpdated: new Date().toISOString(),
                        version: Date.now(),
                        deletedEntryIds: [...new Set([...JSON.parse(localStorage.getItem('deletedDiaryEntries') || '[]'), String(entryId)])]
                    });
                    
                    console.log('九 FIREBASE ELIMINACI칍N PERMANENTE COMPLETADA');
                    
                } catch (error) {
                    console.error('仇 FIREBASE ERROR:', error);
                    setTimeout(forceFirebaseSync, 1500);
                }
            };
            
            forceFirebaseSync();
            
            // 游댑 REACTIVAR DESPU칄S DE 8 SEGUNDOS
            setTimeout(() => {
                atlasApp.tripsyncDisabled = false;
                console.log('游댑 SYNC REACTIVADA');
            }, 8000);
            
            showNotification(`Entrada eliminada permanentemente`, 'success');
        }

        // Hacer funciones disponibles globalmente
        window.createNewTrip = createNewTrip;
        window.createNewRoute = createNewRoute;
        window.editTrip = editTrip;
        window.showRouteDetails = showRouteDetails;
        window.showEditProfile = showEditProfile;
        window.showSettings = showSettings;
        window.logout = logout;
        window.openDiaryModal = openDiaryModal;
        window.closeModal = closeModal;
        window.hideStatusBanner = hideStatusBanner;
        window.clearBudget = clearBudget;
        window.showTripDetails = showTripDetails;
        window.showFullPhoto = showFullPhoto;
        window.addLocationField = addLocationField;
        window.removeLocationField = removeLocationField;
        window.addRouteDay = addRouteDay;
        window.removeRouteDay = removeRouteDay;
        window.deleteRoute = deleteRoute;
        window.deleteDiaryEntry = deleteDiaryEntry;
        window.previewProfilePhoto = previewProfilePhoto;
    </script>

    <!-- Firebase Configuration and Initialization -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAVPE2S57FyqiV9bANTaCCwbptUJ-FE2c8",
            authDomain: "atlas-app-fd6fe.firebaseapp.com",
            databaseURL: "https://atlas-app-fd6fe-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "atlas-app-fd6fe",
            storageBucket: "atlas-app-fd6fe.firebasestorage.app",
            messagingSenderId: "849105585262",
            appId: "1:849105585262:web:34461339649caf48c0927f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const firestore = firebase.firestore();
        const storage = firebase.storage();

        // Firebase Data Synchronization Functions
        const firebaseSync = {
            // Load all data from Firebase
            async loadAllData() {
                try {
                    console.log('游깷 CARGA INICIAL: Obteniendo datos m치s recientes de Firebase...');
                    const user = auth.currentUser;
                    const userId = user ? user.uid : 'anonymous';
                    
                    // Load trips - SINCRONIZACI칍N BIDIRECCIONAL VERDADERA
                    const tripsDoc = await atlasApp.firestore.collection('users').doc(userId).collection('trips').doc('data').get();
                    if (tripsDoc.exists) {
                        const firebaseData = tripsDoc.data().trips || [];
                        const localData = JSON.parse(localStorage.getItem('atlasTrips') || '[]');
                        
                        console.log('游늵 Firebase trips:', firebaseData.length, '| Local trips:', localData.length);
                        
                        // SIEMPRE usar los datos de Firebase como fuente de verdad
                        if (JSON.stringify(firebaseData) !== JSON.stringify(localData)) {
                            console.log('游댃 SINCRONIZACI칍N: Aplicando datos m치s recientes de Firebase');
                            
                            // PROTECCI칍N: Verificar rutas eliminadas para trips
                            const deletedRoutes = JSON.parse(localStorage.getItem('deletedRoutes') || '[]');
                            const filteredFirebaseData = firebaseData.map(trip => ({
                                ...trip,
                                routes: trip.routes ? trip.routes.filter(route => !deletedRoutes.includes(String(route.id))) : []
                            }));
                            
                            atlasApp.trips = filteredFirebaseData;
                            localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
                        } else {
                            console.log('九 Datos sincronizados - Firebase y Local coinciden');
                        }
                    } else {
                        console.log('游닇 No hay datos en Firebase - usando datos locales');
                        if (atlasApp.trips.length > 0) {
                            localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
                        }
                    }
                    
                    // Load diary entries - CON PROTECCI칍N CONTRA ELIMINACIONES
                    const diaryDoc = await firestore.collection('users').doc(userId).collection('diary').doc('data').get();
                    if (diaryDoc.exists) {
                        let firebaseEntries = diaryDoc.data().entries || [];
                        const deletedEntries = JSON.parse(localStorage.getItem('deletedDiaryEntries') || '[]');
                        
                        // FILTRAR entradas eliminadas
                        const filteredEntries = firebaseEntries.filter(entry => !deletedEntries.includes(String(entry.id)));
                        
                        console.log('游늵 Firebase entradas:', firebaseEntries.length, '| Filtradas:', filteredEntries.length);
                        console.log('游뛂 IDs bloqueados:', deletedEntries);
                        
                        atlasApp.diaryEntries = filteredEntries;
                        localStorage.setItem('atlasDiaryEntries', JSON.stringify(atlasApp.diaryEntries));
                    }
                    
                    // Load routes - CON PROTECCI칍N CONTRA ELIMINACIONES
                    const routesDoc = await firestore.collection('users').doc(userId).collection('routes').doc('data').get();
                    if (routesDoc.exists) {
                        let firebaseRoutes = routesDoc.data().routes || [];
                        const deletedRoutes = JSON.parse(localStorage.getItem('deletedRoutes') || '[]');
                        const deletedRouteIdsFromFirebase = routesDoc.data().deletedRouteIds || [];
                        
                        // COMBINAR todas las rutas eliminadas (local + Firebase)
                        const allDeletedRoutes = [...new Set([...deletedRoutes, ...deletedRouteIdsFromFirebase])];
                        
                        // FILTRAR rutas eliminadas
                        const filteredRoutes = firebaseRoutes.filter(route => !allDeletedRoutes.includes(String(route.id)));
                        
                        console.log('游늵 Firebase rutas:', firebaseRoutes.length, '| Filtradas:', filteredRoutes.length);
                        console.log('游뛂 IDs bloqueados:', allDeletedRoutes);
                        
                        atlasApp.routes = filteredRoutes;
                        localStorage.setItem('atlasRoutes', JSON.stringify(atlasApp.routes));
                    }
                    
                    // Load user profile
                    const userDoc = await firestore.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        atlasApp.user = userDoc.data();
                    }
                    
                    console.log('Data loaded successfully from Firebase');
                    
                    // Actualizar UI despu칠s de cargar datos de Firebase
                    loadRecentTrips();
                    updateStatistics();
                    
                    return true;
                } catch (error) {
                    console.warn('Could not load from Firebase, using local data:', error);
                    return false;
                }
            },

            // Save trips to Firebase
            async saveTrips() {
                try {
                    const user = auth.currentUser;
                    const userId = user ? user.uid : 'anonymous';
                    const timestamp = new Date().toISOString();
                    
                    await firestore.collection('users').doc(userId).collection('trips').doc('data').set({
                        trips: atlasApp.trips,
                        lastUpdated: timestamp,
                        syncType: 'manual-update'
                    });
                    
                    // Actualizar timestamp local para tracking de cambios
                    localStorage.setItem('atlasTripsTimestamp', timestamp);
                    
                    console.log('九 Viajes guardados en Firebase con timestamp:', timestamp);
                } catch (error) {
                    console.warn('Could not save trips to Firebase:', error);
                }
            },

            // Save diary entries to Firebase
            async saveDiaryEntries() {
                try {
                    const user = auth.currentUser;
                    const userId = user ? user.uid : 'anonymous';
                    const timestamp = new Date().toISOString();
                    
                    await firestore.collection('users').doc(userId).collection('diary').doc('data').set({
                        entries: atlasApp.diaryEntries,
                        lastUpdated: timestamp,
                        syncType: 'manual-update'
                    });
                    
                    localStorage.setItem('atlasDiaryEntriesTimestamp', timestamp);
                    
                    console.log('九 Diary entries guardadas en Firebase con timestamp:', timestamp);
                } catch (error) {
                    console.warn('Could not save diary entries to Firebase:', error);
                }
            },

            // Save routes to Firebase
            async saveRoutes() {
                try {
                    const user = auth.currentUser;
                    const userId = user ? user.uid : 'anonymous';
                    const timestamp = new Date().toISOString();
                    
                    await firestore.collection('users').doc(userId).collection('routes').doc('data').set({
                        routes: atlasApp.routes,
                        lastUpdated: timestamp,
                        syncType: 'manual-update'
                    });
                    
                    localStorage.setItem('atlasRoutesTimestamp', timestamp);
                    
                    console.log('九 Routes guardadas en Firebase con timestamp:', timestamp);
                } catch (error) {
                    console.warn('Could not save routes to Firebase:', error);
                }
            },

            // Save user profile to Firebase
            async saveUser() {
                try {
                    const user = auth.currentUser;
                    const userId = user ? user.uid : 'anonymous';
                    
                    await firestore.collection('users').doc(userId).set({
                        ...atlasApp.user,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('User data saved to Firebase');
                } catch (error) {
                    console.warn('Could not save user data to Firebase:', error);
                }
            },

            // Enable real-time synchronization
            enableRealtimeSync() {
                const user = auth.currentUser;
                const userId = user ? user.uid : 'anonymous';

                // Real-time trips sync - CON PROTECCI칍N TEMPORAL DURANTE ELIMINACIONES
                firestore.collection('users').doc(userId).collection('trips').doc('data')
                    .onSnapshot((doc) => {
                        // PROTECCI칍N CR칈TICA: NO aplicar real-time sync durante eliminaciones
                        if (atlasApp.tripsyncDisabled) {
                            console.log('游 REAL-TIME SYNC SALTADO (eliminaci칩n en progreso)');
                            return;
                        }
                        
                        if (doc.exists) {
                            const firebaseData = doc.data().trips || [];
                            const firebaseTimestamp = doc.data().lastUpdated || doc.updateTime;
                            const localData = JSON.parse(localStorage.getItem('atlasTrips') || '[]');
                            const localTimestamp = localStorage.getItem('atlasTripsTimestamp');
                            
                            console.log('游댃 Real-time sync detectado');
                            console.log('游늵 Firebase:', firebaseData.length, 'viajes | Local:', localData.length, 'viajes');
                            console.log('游 Firebase timestamp:', firebaseTimestamp, '| Local timestamp:', localTimestamp);
                            
                            // SINCRONIZACI칍N INTELIGENTE con protecci칩n de eliminaciones
                            const shouldUpdate = (() => {
                                // PROTECCI칍N: Si hay rutas eliminadas localmente, no restaurar
                                const deletedRoutes = JSON.parse(localStorage.getItem('deletedRoutes') || '[]');
                                
                                // Si no hay datos locales, siempre usar Firebase
                                if (!localData.length && firebaseData.length) {
                                    // Verificar que Firebase no est칠 enviando rutas eliminadas
                                    const hasDeletedRoutes = firebaseData.some(route => deletedRoutes.includes(String(route.id)));
                                    if (hasDeletedRoutes) {
                                        console.log('游뛂 EVITANDO RESTAURACI칍N DE RUTAS ELIMINADAS');
                                        return false;
                                    }
                                    return true;
                                }
                                
                                // Si los datos son diferentes
                                if (JSON.stringify(firebaseData) !== JSON.stringify(localData)) {
                                    // Si Firebase tiene timestamp m치s reciente
                                    if (firebaseTimestamp && (!localTimestamp || new Date(firebaseTimestamp) > new Date(localTimestamp))) {
                                        // Verificar que Firebase no est칠 enviando rutas eliminadas
                                        const hasDeletedRoutes = firebaseData.some(route => deletedRoutes.includes(String(route.id)));
                                        if (hasDeletedRoutes) {
                                            console.log('游뛂 EVITANDO RESTAURACI칍N DE RUTAS ELIMINADAS');
                                            return false;
                                        }
                                        return true;
                                    }
                                    // Si no hay timestamp en Firebase pero hay datos diferentes, usar Firebase
                                    if (firebaseTimestamp && !localTimestamp) {
                                        return true;
                                    }
                                }
                                return false;
                            })();
                            
                            if (shouldUpdate) {
                                console.log('游댃 SINCRONIZACI칍N: Aplicando cambios desde Firebase');
                                atlasApp.trips = firebaseData;
                                localStorage.setItem('atlasTrips', JSON.stringify(atlasApp.trips));
                                localStorage.setItem('atlasTripsTimestamp', firebaseTimestamp || new Date().toISOString());
                            }
                            
                            if (atlasApp.currentTab === 'dashboard') {
                                loadDashboardContent();
                            }
                        }
                    });

                // Real-time diary sync - CON PROTECCI칍N TEMPORAL DURANTE ELIMINACIONES
                firestore.collection('users').doc(userId).collection('diary').doc('data')
                    .onSnapshot((doc) => {
                        // PROTECCI칍N CR칈TICA: NO aplicar real-time sync durante eliminaciones
                        if (atlasApp.tripsyncDisabled) {
                            console.log('游 REAL-TIME DIARY SYNC SALTADO (eliminaci칩n en progreso)');
                            return;
                        }
                        
                        if (doc.exists) {
                            const firebaseEntries = doc.data().entries || [];
                            const firebaseTimestamp = doc.data().lastUpdated || doc.updateTime;
                            const localEntries = JSON.parse(localStorage.getItem('atlasDiaryEntries') || '[]');
                            const localTimestamp = localStorage.getItem('atlasDiaryEntriesTimestamp');
                            
                            console.log('游늾 Real-time diary sync detectado');
                            console.log('游늵 Firebase:', firebaseEntries.length, 'entradas | Local:', localEntries.length);
                            console.log('游 Firebase timestamp:', firebaseTimestamp, '| Local timestamp:', localTimestamp);
                            
                            // SINCRONIZACI칍N INTELIGENTE con protecci칩n de eliminaciones
                            const shouldUpdate = (() => {
                                // PROTECCI칍N: Si hay entradas eliminadas localmente, no restaurar
                                const deletedEntries = JSON.parse(localStorage.getItem('deletedDiaryEntries') || '[]');
                                
                                // Si no hay datos locales, siempre usar Firebase
                                if (!localEntries.length && firebaseEntries.length) {
                                    // Verificar que Firebase no est칠 enviando entradas eliminadas
                                    const hasDeletedEntries = firebaseEntries.some(entry => deletedEntries.includes(String(entry.id)));
                                    if (hasDeletedEntries) {
                                        console.log('游뛂 EVITANDO RESTAURACI칍N DE ENTRADAS ELIMINADAS');
                                        return false;
                                    }
                                    return true;
                                }
                                
                                // Si los datos son diferentes
                                if (JSON.stringify(firebaseEntries) !== JSON.stringify(localEntries)) {
                                    // Si Firebase tiene timestamp m치s reciente
                                    if (firebaseTimestamp && (!localTimestamp || new Date(firebaseTimestamp) > new Date(localTimestamp))) {
                                        // Verificar que Firebase no est칠 enviando entradas eliminadas
                                        const hasDeletedEntries = firebaseEntries.some(entry => deletedEntries.includes(String(entry.id)));
                                        if (hasDeletedEntries) {
                                            console.log('游뛂 EVITANDO RESTAURACI칍N DE ENTRADAS ELIMINADAS');
                                            return false;
                                        }
                                        return true;
                                    }
                                    // Si no hay timestamp en Firebase pero hay datos diferentes, usar Firebase
                                    if (firebaseTimestamp && !localTimestamp) {
                                        return true;
                                    }
                                }
                                return false;
                            })();
                            
                            if (shouldUpdate) {
                                console.log('游댃 SINCRONIZACI칍N DIARY: Aplicando cambios desde Firebase');
                                atlasApp.diaryEntries = firebaseEntries;
                                localStorage.setItem('atlasDiaryEntries', JSON.stringify(atlasApp.diaryEntries));
                                localStorage.setItem('atlasDiaryEntriesTimestamp', firebaseTimestamp || new Date().toISOString());
                            }
                            
                            if (atlasApp.currentTab === 'diary') {
                                loadDiaryContent();
                            }
                        }
                    });

                // Real-time routes sync - CON PROTECCI칍N TEMPORAL DURANTE ELIMINACIONES
                firestore.collection('users').doc(userId).collection('routes').doc('data')
                    .onSnapshot((doc) => {
                        // PROTECCI칍N CR칈TICA: NO aplicar real-time sync durante eliminaciones
                        if (atlasApp.tripsyncDisabled) {
                            console.log('游 REAL-TIME ROUTES SYNC SALTADO (eliminaci칩n en progreso)');
                            return;
                        }
                        
                        if (doc.exists) {
                            const firebaseRoutes = doc.data().routes || [];
                            const firebaseTimestamp = doc.data().lastUpdated || doc.updateTime;
                            const localRoutes = JSON.parse(localStorage.getItem('atlasRoutes') || '[]');
                            const localTimestamp = localStorage.getItem('atlasRoutesTimestamp');
                            
                            console.log('游띣勇 Real-time routes sync detectado');
                            console.log('游늵 Firebase:', firebaseRoutes.length, 'rutas | Local:', localRoutes.length);
                            console.log('游 Firebase timestamp:', firebaseTimestamp, '| Local timestamp:', localTimestamp);
                            
                            // SINCRONIZACI칍N INTELIGENTE con protecci칩n de eliminaciones COMPLETA
                            const shouldUpdate = (() => {
                                // PROTECCI칍N: Verificar tanto local como Firebase
                                const deletedRoutes = JSON.parse(localStorage.getItem('deletedRoutes') || '[]');
                                const deletedRouteIdsFromFirebase = doc.data().deletedRouteIds || [];
                                
                                // COMBINAR todas las rutas eliminadas (local + Firebase)
                                const allDeletedRoutes = [...new Set([...deletedRoutes, ...deletedRouteIdsFromFirebase])];
                                
                                // Si no hay datos locales, siempre usar Firebase
                                if (!localRoutes.length && firebaseRoutes.length) {
                                    // Verificar que Firebase no est칠 enviando rutas eliminadas
                                    const hasDeletedRoutes = firebaseRoutes.some(route => allDeletedRoutes.includes(String(route.id)));
                                    if (hasDeletedRoutes) {
                                        console.log('游뛂 EVITANDO RESTAURACI칍N DE RUTAS ELIMINADAS');
                                        console.log('游댌 ID(s) bloqueado(s):', firebaseRoutes.filter(route => allDeletedRoutes.includes(String(route.id))).map(r => r.id));
                                        return false;
                                    }
                                    return true;
                                }
                                
                                // Si los datos son diferentes
                                if (JSON.stringify(firebaseRoutes) !== JSON.stringify(localRoutes)) {
                                    // Si Firebase tiene timestamp m치s reciente
                                    if (firebaseTimestamp && (!localTimestamp || new Date(firebaseTimestamp) > new Date(localTimestamp))) {
                                        // Verificar que Firebase no est칠 enviando rutas eliminadas
                                        const hasDeletedRoutes = firebaseRoutes.some(route => allDeletedRoutes.includes(String(route.id)));
                                        if (hasDeletedRoutes) {
                                            console.log('游뛂 EVITANDO RESTAURACI칍N DE RUTAS ELIMINADAS');
                                            console.log('游댌 ID(s) bloqueado(s):', firebaseRoutes.filter(route => allDeletedRoutes.includes(String(route.id))).map(r => r.id));
                                            return false;
                                        }
                                        return true;
                                    }
                                    // Si no hay timestamp en Firebase pero hay datos diferentes, usar Firebase
                                    if (firebaseTimestamp && !localTimestamp) {
                                        // Verificar que Firebase no est칠 enviando rutas eliminadas
                                        const hasDeletedRoutes = firebaseRoutes.some(route => allDeletedRoutes.includes(String(route.id)));
                                        if (hasDeletedRoutes) {
                                            console.log('游뛂 EVITANDO RESTAURACI칍N DE RUTAS ELIMINADAS');
                                            console.log('游댌 ID(s) bloqueado(s):', firebaseRoutes.filter(route => allDeletedRoutes.includes(String(route.id))).map(r => r.id));
                                            return false;
                                        }
                                        return true;
                                    }
                                }
                                return false;
                            })();
                            
                            if (shouldUpdate) {
                                console.log('游댃 SINCRONIZACI칍N ROUTES: Aplicando cambios desde Firebase');
                                atlasApp.routes = firebaseRoutes;
                                localStorage.setItem('atlasRoutes', JSON.stringify(atlasApp.routes));
                                localStorage.setItem('atlasRoutesTimestamp', firebaseTimestamp || new Date().toISOString());
                            }
                            
                            if (atlasApp.currentTab === 'routes') {
                                loadRoutesContent();
                            }
                        }
                    });

                console.log('Real-time synchronization enabled');
            }
        };

        // Initialize Atlas App with Firebase
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof atlasApp !== 'undefined') {
                // Extend atlasApp with Firebase functionality
                atlasApp.auth = auth;
                atlasApp.database = database;
                atlasApp.firestore = firestore;
                atlasApp.storage = storage;
                atlasApp.firebaseSync = firebaseSync;
                
                // Enable Firebase sync by default
                atlasApp.firebaseSyncEnabled = true;
                atlasApp.tripsyncDisabled = false; // Inicializar protecci칩n contra interferencias
                
                // Try to load data from Firebase first
                await firebaseSync.loadAllData();
                
                // Enable real-time sync
                firebaseSync.enableRealtimeSync();
                
                console.log('Atlas app initialized with Firebase sync enabled');
            }
        });
    </script>
</body>
</html>
